<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orthologous Gene – Disease/Tissue Dashboard</title>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 1rem 2rem 3rem;
      background: #fdf6ff;
      color: #333;
    }
    h1 {
      margin-top: 0;
      text-align: center;
      background: #a278ff;
      color: white;
      padding: 0.6rem 1rem;
      border-radius: 12px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      margin: 1rem 0;
    }
    .controls label {
      font-size: 0.9rem;
    }
    button {
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      border: none;
      background: #a278ff;
      color: white;
      cursor: pointer;
      font-weight: 600;
    }
    button:disabled {
      background: #cbb6ff;
      cursor: wait;
    }
    #status {
      font-size: 0.9rem;
      color: #666;
    }
    .stats-box {
      background: white;
      border-radius: 12px;
      padding: 0.75rem 1rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 1rem;
    }
    .stats-box strong {
      color: #5a2fbf;
    }
    .charts {
      display: grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
      gap: 1.5rem;
    }
    @media (max-width: 950px) {
      .charts {
        grid-template-columns: minmax(0,1fr);
      }
    }
    #barChart, #heatmap {
      width: 100%;
      height: 450px;
    }
    .small {
      font-size: 0.8rem;
      color: #777;
    }
  </style>
</head>
<body>
  <h1>Orthologous Cluster Analysis Dashboard</h1>

  <div class="controls">
    <button id="reloadBtn">Reload data</button>
    <label>
      Show top
      <select id="topNSelect">
        <option value="10">10 diseases</option>
        <option value="15" selected>15 diseases</option>
        <option value="20">20 diseases</option>
        <option value="30">30 diseases</option>
      </select>
      in bar chart
    </label>
    <span id="status">Waiting to load…</span>
  </div>

  <div class="stats-box" id="statsBox">
    Loading statistics…
  </div>

  <div class="charts">
    <div>
      <h2>Top Diseases by Number of Human Genes</h2>
      <div id="barChart"></div>
      <p class="small">
        Bars show how many distinct <strong>human genes</strong> (with rat orthologs) are associated with each disease
        in the current result set (LIMIT 1000).
      </p>
    </div>
    <div>
      <h2>Disease × Tissue Gene Counts (Heatmap)</h2>
      <div id="heatmap"></div>
      <p class="small">
        Heatmap cells show the number of distinct human genes for each
        (disease, tissue) pair. Only combinations present in the 1000-row sample are shown.
      </p>
    </div>
  </div>

  <script>
    const ENDPOINT = "https://query.wikidata.org/sparql";

    // Your original query (LIMIT 1000)
    const QUERY = `
    SELECT
      ?humanGene ?humanGeneLabel
      ?ratGene ?ratGeneLabel
      ?disease ?diseaseLabel
      ?tissue ?tissueLabel
      (SAMPLE(?humanEnsembl) AS ?humanEnsembl)
      (SAMPLE(?ratEnsembl)   AS ?ratEnsembl)
    WHERE {
      # Human gene
      ?humanGene wdt:P703 wd:Q15978631 ;   # found in taxon: Homo sapiens
                 wdt:P594 ?humanEnsembl ;  # Ensembl Gene ID
                 wdt:P2293 ?disease ;      # genetic association: gene → disease
                 wdt:P684 ?ratGene .       # ortholog: human ↔ rat
      # Rat gene
      ?ratGene  wdt:P703 wd:Q184224 ;      # found in taxon: Rattus norvegicus
                wdt:P594 ?ratEnsembl .     # Ensembl Gene ID
      # Disease → tissue/organ affected
      ?disease wdt:P927 ?tissue .          # anatomical structure affected
      SERVICE wikibase:label {
        bd:serviceParam wikibase:language "en".
      }
    }
    GROUP BY
      ?humanGene ?humanGeneLabel
      ?ratGene ?ratGeneLabel
      ?disease ?diseaseLabel
      ?tissue ?tissueLabel
    LIMIT 1000
    `;

    const statusEl = document.getElementById("status");
    const statsBox = document.getElementById("statsBox");
    const reloadBtn = document.getElementById("reloadBtn");
    const topNSelect = document.getElementById("topNSelect");

    reloadBtn.addEventListener("click", () => loadAndRender());

    topNSelect.addEventListener("change", () => {
      if (window.__cachedData) {
        renderAll(window.__cachedData);
      }
    });

    async function runQuery() {
      const url = ENDPOINT + "?format=json&query=" + encodeURIComponent(QUERY);
      const res = await fetch(url, {
        headers: {
          "Accept": "application/sparql-results+json"
        }
      });
      if (!res.ok) {
        throw new Error("SPARQL request failed: " + res.status);
      }
      return res.json();
    }

    function computeStats(bindings) {
      const nodes = new Set();
      const edges = new Set();

      const diseaseGeneCounts = new Map();      // diseaseLabel -> Set(humanGene)
      const dtCounts = new Map();              // "diseaseLabel|tissueLabel" -> Set(humanGene)

      for (const row of bindings) {
        const h = row.humanGene.value;
        const r = row.ratGene.value;
        const d = row.disease.value;
        const t = row.tissue.value;

        const dLabel = row.diseaseLabel.value;
        const tLabel = row.tissueLabel.value;

        // nodes
        nodes.add(h);
        nodes.add(r);
        nodes.add(d);
        nodes.add(t);

        // edges (deduplicated with key)
        edges.add(h + "|" + d); // humanGene -> disease
        edges.add(h + "|" + r); // humanGene -> ratGene
        edges.add(d + "|" + t); // disease -> tissue

        // disease -> gene counts
        if (!diseaseGeneCounts.has(dLabel)) {
          diseaseGeneCounts.set(dLabel, new Set());
        }
        diseaseGeneCounts.get(dLabel).add(h);

        // (disease, tissue) -> gene counts
        const keyDT = dLabel + "|" + tLabel;
        if (!dtCounts.has(keyDT)) {
          dtCounts.set(keyDT, new Set());
        }
        dtCounts.get(keyDT).add(h);
      }

      // convert disease counts to array
      const diseaseCountsArray = Array.from(diseaseGeneCounts.entries())
        .map(([dLabel, geneSet]) => ({ disease: dLabel, count: geneSet.size }))
        .sort((a, b) => b.count - a.count);

      // unique diseases & tissues for heatmap axes
      const diseaseLabels = Array.from(new Set(
        Array.from(dtCounts.keys()).map(k => k.split("|")[0])
      ));
      const tissueLabels = Array.from(new Set(
        Array.from(dtCounts.keys()).map(k => k.split("|")[1])
      ));

      // build matrix (rows = diseases, cols = tissues)
      const matrix = diseaseLabels.map(() => tissueLabels.map(() => 0));
      for (const [key, geneSet] of dtCounts.entries()) {
        const [dLabel, tLabel] = key.split("|");
        const i = diseaseLabels.indexOf(dLabel);
        const j = tissueLabels.indexOf(tLabel);
        if (i >= 0 && j >= 0) {
          matrix[i][j] = geneSet.size;
        }
      }

      return {
        nodeCount: nodes.size,
        edgeCount: edges.size,
        resultCount: bindings.length,
        uniqueDiseases: diseaseGeneCounts.size,
        uniqueTissues: tissueLabels.length,
        diseaseCountsArray,
        diseaseLabels,
        tissueLabels,
        matrix
      };
    }

    function renderStats(stats) {
      statsBox.innerHTML = `
        <div><strong>${stats.resultCount}</strong> rows in sample (LIMIT 1000)</div>
        <div>
          <strong>${stats.nodeCount}</strong> unique nodes
          &nbsp;•&nbsp;
          <strong>${stats.edgeCount}</strong> unique edges
        </div>
        <div>
          <strong>${stats.uniqueDiseases}</strong> diseases,
          <strong>${stats.uniqueTissues}</strong> tissues
          represented in this sample.
        </div>
      `;
    }

    function renderBarChart(stats) {
      const topN = parseInt(topNSelect.value, 10);
      const top = stats.diseaseCountsArray.slice(0, topN);

      const trace = {
        x: top.map(d => d.disease),
        y: top.map(d => d.count),
        type: "bar",
        marker: {
          // leave default colors; Plotly will pick a palette
        }
      };

      const layout = {
        margin: { t: 30, b: 150, l: 70, r: 10 },
        xaxis: {
          tickangle: -45,
          automargin: true
        },
        yaxis: {
          title: "Distinct human genes (with rat orthologs)"
        }
      };

      Plotly.newPlot("barChart", [trace], layout, {responsive: true});
    }

    function renderHeatmap(stats) {
      // For readability, limit to the same top diseases as the bar chart
      const topN = parseInt(topNSelect.value, 10);
      const topDiseaseLabels = stats.diseaseCountsArray
        .slice(0, topN)
        .map(d => d.disease);

      // Filter matrix accordingly
      const indices = topDiseaseLabels.map(lbl => stats.diseaseLabels.indexOf(lbl));
      const z = indices.map(i => stats.matrix[i]);

      const trace = {
        z,
        x: stats.tissueLabels,
        y: topDiseaseLabels,
        type: "heatmap",
        colorscale: "Viridis",
        hoverongaps: false
      };

      const layout = {
        margin: { t: 30, b: 120, l: 150, r: 10 },
        xaxis: {
          automargin: true,
          tickangle: -45
        },
        yaxis: {
          automargin: true
        }
      };

      Plotly.newPlot("heatmap", [trace], layout, {responsive: true});
    }

    function renderAll(bindings) {
      const stats = computeStats(bindings);
      renderStats(stats);
      renderBarChart(stats);
      renderHeatmap(stats);
    }

    async function loadAndRender() {
      try {
        reloadBtn.disabled = true;
        statusEl.textContent = "Loading from Wikidata SPARQL endpoint…";
        const json = await runQuery();
        const bindings = json.results.bindings;
        window.__cachedData = bindings;
        renderAll(bindings);
        statusEl.textContent = "Loaded " + bindings.length + " rows from Wikidata.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Error: " + err.message;
        statsBox.textContent = "Failed to load data.";
      } finally {
        reloadBtn.disabled = false;
      }
    }

    // Auto-load on page open
    loadAndRender();
  </script>
</body>
</html>
